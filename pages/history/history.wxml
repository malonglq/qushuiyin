<!--pages/history/history.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="search-section">
    <view class="search-bar">
      <text class="search-icon">ğŸ”</text>
      <input 
        class="search-input" 
        placeholder="æœç´¢å†å²è®°å½•..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
      />
      <text 
        class="search-clear" 
        bindtap="clearSearch"
        wx:if="{{searchKeyword}}"
      >
        âœ•
      </text>
    </view>
    
    <view class="filter-tabs">
      <view 
        class="filter-tab {{filterType === 'all' ? 'active' : ''}}"
        bindtap="filterHistory"
        data-type="all"
      >
        å…¨éƒ¨
      </view>
      <view 
        class="filter-tab {{filterType === 'today' ? 'active' : ''}}"
        bindtap="filterHistory"
        data-type="today"
      >
        ä»Šå¤©
      </view>
      <view 
        class="filter-tab {{filterType === 'week' ? 'active' : ''}}"
        bindtap="filterHistory"
        data-type="week"
      >
        æœ¬å‘¨
      </view>
      <view 
        class="filter-tab {{filterType === 'month' ? 'active' : ''}}"
        bindtap="filterHistory"
        data-type="month"
      >
        æœ¬æœˆ
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-section">
    <view class="empty-state" wx:if="{{filteredHistory.length === 0}}">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— å†å²è®°å½•</text>
      <text class="empty-desc">å¼€å§‹å¤„ç†å›¾ç‰‡åï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
      <button 
        class="btn btn-primary empty-btn" 
        bindtap="goToHome"
      >
        å»å¤„ç†å›¾ç‰‡
      </button>
    </view>
    
    <scroll-view 
      class="history-list" 
      scroll-y 
      wx:else
    >
      <!-- æŒ‰æ—¥æœŸåˆ†ç»„ -->
      <view class="date-group" wx:for="{{groupedHistory}}" wx:key="date">
        <view class="date-header">
          <text class="date-text">{{item.date}}</text>
          <text class="date-count">{{item.items.length}}å¼ </text>
        </view>
        
        <view class="history-items">
          <view 
            class="history-item" 
            wx:for="{{item.items}}" 
            wx:key="id" 
            wx:for-item="historyItem"
            bindtap="viewHistoryItem"
            data-id="{{historyItem.id}}"
          >
            <view class="item-image">
              <image 
                class="image-thumbnail" 
                src="{{historyItem.thumbnail || historyItem.processedPath || historyItem.originalPath}}" 
                mode="aspectFill"
              />
              <view class="image-status">
                <text class="status-icon {{historyItem.saved ? 'saved' : 'processed'}}">
                  {{historyItem.saved ? 'ğŸ’¾' : 'âœ“'}}
                </text>
              </view>
            </view>
            
            <view class="item-info">
              <view class="item-header">
                <text class="item-name">{{historyItem.name}}</text>
                <text class="item-time">{{formatTime(historyItem.timestamp)}}</text>
              </view>
              
              <view class="item-details">
                <view class="detail-item">
                  <text class="detail-label">è´¨é‡:</text>
                  <text class="detail-value">{{getQualityText(historyItem.quality)}}</text>
                </view>
                <view class="detail-item">
                  <text class="detail-label">æ¨¡å¼:</text>
                  <text class="detail-value">{{historyItem.processMode === 'auto' ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}}</text>
                </view>
                <view class="detail-item">
                  <text class="detail-label">å¤§å°:</text>
                  <text class="detail-value">{{formatFileSize(historyItem.size)}}</text>
                </view>
              </view>
              
              <view class="item-actions">
                <button 
                  class="action-btn" 
                  bindtap="saveImage"
                  data-id="{{historyItem.id}}"
                  data-event="save"
                  catchtap="true"
                  wx:if="{{!historyItem.saved}}"
                >
                  ğŸ’¾ ä¿å­˜
                </button>
                <button 
                  class="action-btn" 
                  bindtap="shareImage"
                  data-id="{{historyItem.id}}"
                  data-event="share"
                  catchtap="true"
                >
                  ğŸ“¤ åˆ†äº«
                </button>
                <button 
                  class="action-btn" 
                  bindtap="deleteImage"
                  data-id="{{historyItem.id}}"
                  data-event="delete"
                  catchtap="true"
                >
                  ğŸ—‘ï¸ åˆ é™¤
                </button>
              </view>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section" wx:if="{{filteredHistory.length > 0}}">
    <view class="stats-container">
      <view class="stats-item">
        <text class="stats-number">{{stats.total}}</text>
        <text class="stats-label">æ€»å¤„ç†</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{stats.saved}}</text>
        <text class="stats-label">å·²ä¿å­˜</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{stats.today}}</text>
        <text class="stats-label">ä»Šæ—¥</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{stats.thisWeek}}</text>
        <text class="stats-label">æœ¬å‘¨</text>
      </view>
    </view>
  </view>

  <!-- æ¸…ç©ºæŒ‰é’® -->
  <view class="clear-section" wx:if="{{filteredHistory.length > 0}}">
    <button 
      class="btn btn-danger clear-btn" 
      bindtap="clearAllHistory"
    >
      æ¸…ç©ºæ‰€æœ‰è®°å½•
    </button>
  </view>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <view class="bottom-nav">
    <view class="nav-item" bindtap="goToHome">
      <text class="nav-icon">ğŸ </text>
      <text class="nav-text">é¦–é¡µ</text>
    </view>
    <view class="nav-item active">
      <text class="nav-icon">ğŸ“‹</text>
      <text class="nav-text">å†å²</text>
    </view>
    <view class="nav-item" bindtap="goToSettings">
      <text class="nav-icon">âš™ï¸</text>
      <text class="nav-text">è®¾ç½®</text>
    </view>
  </view>
</view>